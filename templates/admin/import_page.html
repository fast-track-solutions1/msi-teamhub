{% extends "admin/base_site.html" %}
{% load static %}
{% block title %}Importation - MSI TeamHub{% endblock %}
{% block extrastyle %}<style>
*{margin:0;padding:0;box-sizing:border-box}body{background:#f5f7fa}.import-container{max-width:1100px;margin:20px auto;background:white;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.08)}.import-header{background:linear-gradient(135deg,#2d5266 0%,#417690 100%);color:white;padding:40px;border-bottom:4px solid #1a3a47}.import-header h1{margin:0;font-size:32px;font-weight:700;color:#fff}.import-header-subtitle{font-size:13px;color:#e8f0f5;margin-top:4px}.import-content{padding:40px}.form-section{background:#f9fafc;padding:28px;border-radius:10px;margin-bottom:28px;border:2px solid #e0e6f0;border-left:5px solid #417690}.form-section h3{font-size:18px;font-weight:700;color:#2d5266;margin-bottom:20px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:10px;font-weight:600;color:#333;font-size:14px}.form-group select,.form-group input[type="file"]{width:100%;padding:14px 16px;border:2px solid #d0d8e0;border-radius:8px;font-size:14px;background:white;color:#333}.form-group select:focus,.form-group input[type="file"]:focus{outline:0;border-color:#417690;background:#fafbfc;box-shadow:0 0 0 4px rgba(65,118,144,.1)}.selected-model{background:linear-gradient(135deg,#e8f2f7 0%,#f0f7fc 100%);border:2px solid #417690;padding:16px;border-radius:8px;margin-top:15px;display:none}.selected-model.visible{display:block}.model-badge{display:inline-block;background:#417690;color:white;padding:8px 16px;border-radius:6px;font-weight:600;font-size:14px}.download-section{margin-top:20px;padding:16px;background:linear-gradient(135deg,#fff9e6 0%,#fffbf0 100%);border-left:4px solid #ffc107;border-radius:6px;display:none}.download-section.visible{display:block}.download-link{color:#417690;font-weight:600;text-decoration:none;cursor:pointer;display:inline-flex;align-items:center;gap:8px}.download-link:hover{color:#2d5266;text-decoration:underline}#model-structure{margin-top:20px;padding:20px;background:linear-gradient(135deg,#f0f4f8 0%,#e8ecf1 100%);border-radius:8px;border:2px dashed #417690;display:none}#model-structure.visible{display:block}#model-structure h4{font-size:16px;font-weight:600;color:#2d5266;margin-bottom:15px}.table-simple{width:100%;border-collapse:collapse;font-size:14px;margin-top:15px;border-radius:6px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}.table-simple th{background:linear-gradient(135deg,#2d5266 0%,#417690 100%);color:white;padding:14px;text-align:left;font-weight:600;font-size:13px}.table-simple td{padding:12px 14px;border-bottom:1px solid #e0e0e0;background:white;color:#333}.table-simple tbody tr:hover{background:#f9fafc}.button-group{display:flex;gap:12px;margin-top:28px}.btn{padding:14px 28px;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s ease}.btn-primary{background:linear-gradient(135deg,#417690 0%,#2d5266 100%);color:white;box-shadow:0 4px 12px rgba(65,118,144,.3)}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(65,118,144,.4)}.btn-secondary{background:#6c757d;color:white}.btn-secondary:hover{background:#5a6268;transform:translateY(-2px)}.results-section{background:white;padding:28px;border-radius:10px;margin-top:28px;border:2px solid #e0e6f0;border-left:5px solid #417690;display:none}.results-section.visible{display:block}.results-section.success{border-left-color:#28a745;background:#f8fdf9}.results-section.warning{border-left-color:#ffc107;background:#fffbf0}.result-stat{padding:16px;margin-bottom:12px;border-radius:8px;font-weight:500;font-size:15px}.result-stat.success{background:#d4edda;color:#155724;border-left:4px solid #28a745}.result-stat.warning{background:#fff3cd;color:#856404}.result-stat.error{background:#f8d7da;color:#721c24}.info-box{background:linear-gradient(135deg,#e8f5f9 0%,#f0fbfc 100%);border-left:4px solid #0c5460;border:2px solid #b3e5fc;padding:24px;border-radius:8px;color:#0c5460}.info-box h4{color:#0c5460;margin-top:0;margin-bottom:16px;font-size:16px;font-weight:700}.info-box ol{margin-left:20px;line-height:1.8}.history-section{background:linear-gradient(135deg,#f0f4f8 0%,#e8ecf1 100%);border:2px solid #d0d8e0;padding:28px;border-radius:10px;margin-top:28px}.history-section h3{color:#2d5266;margin-bottom:20px;font-size:20px;font-weight:700}.history-link{margin-top:16px;font-size:14px}.history-link a{color:#417690;text-decoration:none;font-weight:600}
</style>{% endblock %}
{% block content %}
<div class="import-container">
<div class="import-header"><div><h1>üì• Importation en Masse</h1><div class="import-header-subtitle">G√©rez vos donn√©es en masse facilement</div></div></div>
<div class="import-content">
<form method="post" enctype="multipart/form-data" id="import-form">{% csrf_token %}
<div class="form-section"><h3>üìã √âtape 1 : S√©lectionnez le type</h3>
<div class="form-group"><label for="model-select">Mod√®le *</label>
<select name="model" id="model-select" required onchange="updateTemplate()">
<option value="">-- S√©lectionnez --</option>
{% for model in models %}<option value="{{ model.key }}">{{ model.name }}</option>{% endfor %}
</select></div>
<div class="selected-model" id="selected-model"><strong>‚úÖ S√©lectionn√© :</strong> <span class="model-badge" id="model-badge"></span></div>
<div class="download-section" id="download-section"><a href="#" class="download-link" id="download-link" onclick="return downloadTemplate()">‚¨áÔ∏è T√©l√©charger template</a></div>
<div id="model-structure"><h4>üìä Champs</h4><table class="table-simple"><thead><tr><th>Champ</th><th>Type</th><th>Obligatoire</th><th>Cl√©</th></tr></thead><tbody id="model-structure-body"><tr><td colspan="4" style="text-align:center;padding:20px">Chargement...</td></tr></tbody></table></div>
</div>
<div class="form-section"><h3>üìÑ √âtape 2 : Fichier Excel</h3>
<div class="form-group"><label for="file-input">Fichier (.xlsx,.xls) *</label>
<input type="file" name="file" id="file-input" accept=".xlsx,.xls" required></div>
</div>
<div class="form-section"><div class="button-group">
<button type="submit" class="btn btn-primary">‚úÖ Lancer l'import</button>
<button type="reset" class="btn btn-secondary">üîÑ R√©initialiser</button>
</div></div>
</form>
{% if result %}
<div class="form-section results-section visible {% if result.errors %}warning{% endif %}">
<h3>‚úÖ R√©sultats</h3>
<div class="result-stat success">‚úÖ Ins√©r√©es: {{ result.inserted }}</div>
<div class="result-stat success">üîÑ Mises √† jour: {{ result.updated }}</div>
{% if result.errors %}
<div class="result-stat error">‚ùå Erreurs: {{ result.errors|length }}</div>
<details><summary style="cursor:pointer;color:#dc3545;font-weight:600;padding:8px;background:#f8d7da;border-radius:3px">D√©tails ({{ result.errors|length }})</summary>
<div style="max-height:350px;overflow-y:auto;background:#f8f9fa;border:2px solid #dee2e6;border-radius:6px;padding:15px;margin-top:15px">
{% for error in result.errors %}<div style="padding:10px;margin-bottom:10px;background:#f8d7da;border-left:4px solid #dc3545;color:#721c24;border-radius:4px"><strong>Ligne {{ error.row }}:</strong> {{ error.error }}</div>{% endfor %}
</div></details>
{% endif %}
</div>
{% endif %}
{% if not result %}
<div class="form-section info-box">
<h4>‚ÑπÔ∏è Comment utiliser :</h4>
<ol><li>S√©lectionnez le type de donn√©es</li><li>T√©l√©chargez le template Excel</li><li>Remplissez avec vos donn√©es</li><li>Uploadez et lancez l'import</li><li>Consultez les r√©sultats</li></ol>
</div>
{% endif %}
<div class="history-section">
<h3>üìä Derniers imports</h3>
<table class="table-simple"><thead><tr><th>Date</th><th>Mod√®le</th><th>Statut</th><th>Succ√®s</th><th>Erreurs</th><th>Par</th></tr></thead><tbody id="history-body"><tr><td colspan="6" style="text-align:center;padding:20px">Chargement...</td></tr></tbody></table>
<div class="history-link">üîé <a href="{% url 'admin:api_importlog_changelist' %}">Voir tout l'historique</a></div>
</div>
</div>
</div>
<script>
function updateTemplate(){const m=document.getElementById('model-select').value;const sel=document.getElementById('selected-model');const dl=document.getElementById('download-section');const st=document.getElementById('model-structure');if(!m){sel.classList.remove('visible');dl.classList.remove('visible');st.classList.remove('visible');return}document.getElementById('model-badge').textContent=document.querySelector('#model-select option:checked').text;sel.classList.add('visible');dl.classList.add('visible');fetch('/admin/import/api/structure/?model='+m).then(r=>r.json()).then(d=>{if(!d.structure||!d.structure.fields)return;const t=d.structure.fields.map(f=>`<tr><td>${f.name}</td><td>${f.type}</td><td>${f.required?'Oui':'Non'}</td><td>${f.name===d.structure.unique_field?'Oui':''}</td></tr>`).join('');document.getElementById('model-structure-body').innerHTML=t;st.classList.add('visible')}).catch(()=>st.classList.remove('visible'))}
function downloadTemplate(){const m=document.getElementById('model-select').value;if(!m){alert('S√©lectionnez un mod√®le');return false}window.location.href='{% url "admin_download_template" %}?model='+m;return false}
function loadHistory(){fetch('/api/import/history/').then(r=>r.json()).then(d=>{const tb=document.getElementById('history-body');if(!d.logs||!d.logs.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center">Aucun import</td></tr>';return}tb.innerHTML=d.logs.slice(0,10).map(l=>`<tr><td>${l.date_creation}</td><td>${l.api_name}</td><td>${l.statut}</td><td>${l.lignes_succes}</td><td>${l.lignes_erreur}</td><td>${l.cree_par||''}</td></tr>`).join('')}).catch(()=>document.getElementById('history-body').innerHTML='<tr><td colspan="6" style="color:#c00">Erreur</td></tr>')}
document.addEventListener('DOMContentLoaded',loadHistory);
</script>
{% endblock %}
